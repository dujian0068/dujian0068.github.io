
<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="utf-8" />
    <title>短链系统设计 | bmilk</title>
    <meta name="author" content="Du Jian" />
    <meta name="description" content="" />
    <meta name="keywords" content="" />
    <meta
        name="viewport"
        content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=0"
    />
    <link rel="icon" href="/images/avatar-link.jpg" />
    <link rel="preconnect" href="https://s4.zstatic.net" />
<script src="https://s4.zstatic.net/ajax/libs/vue/3.3.7/vue.global.prod.min.js"></script>
<link rel="stylesheet" href="https://s4.zstatic.net/ajax/libs/font-awesome/6.4.2/css/all.min.css" />
<link rel="preconnect" href="https://fonts.googleapis.cn" />
<link rel="preconnect" href="https://fonts.gstatic.cn" crossorigin />
<link
    rel="stylesheet"
    href="https://fonts.googleapis.cn/css2?family=Fira+Code:wght@400;500;600;700&family=Lexend:wght@400;500;600;700;800;900&family=Noto+Sans+SC:wght@400;500;600;700;800;900&display=swap"
/>
<script> const mixins = {}; </script>

<script src="https://polyfill.alicdn.com/v3/polyfill.min.js?features=default"></script>


<script src="https://s4.zstatic.net/ajax/libs/highlight.js/11.9.0/highlight.min.js"></script>
<!--<script type="text/javascript" src="/js/highlight/highlight.js"></script>-->
<script src="https://s4.zstatic.net/ajax/libs/highlightjs-line-numbers.js/2.8.0/highlightjs-line-numbers.min.js"></script>
 <link
     rel="stylesheet"
     href="https://s4.zstatic.net/ajax/libs/highlight.js/11.9.0/styles/androidstudio.min.css"
 />
<!--<link-->
<!--    rel="stylesheet"-->
<!--    href="/css/highlight/androidstudio.css"-->
<!--/>-->
<script src="/js/lib/highlight.js"></script>



<script src="/js/lib/preview.js"></script>









<link rel="stylesheet" href="/css/main.css" />

<meta name="generator" content="Hexo 7.3.0"></head>
<body>
    <div id="layout">
        <transition name="fade">
            <div id="loading" v-show="loading">
                <div id="loading-circle">
                    <h2>LOADING...</h2>
                    <p>起身休息一下吧，比如痛痛快快上个厕所什么的</p>
                    <img src="/images/loading.gif" />
                </div>
            </div>
        </transition>
        <div id="menu" :class="{ hidden: hiddenMenu, 'menu-color': menuColor}">
    <nav id="desktop-menu">
        <a class="title" href="/">
            <span>BMILK</span>
        </a>
        
        <a href="/">
            <i class="fa-solid fa-house fa-fw"></i>
            <span>&ensp;Home</span>
        </a>
        
        <a href="/about">
            <i class="fa-solid fa-id-card fa-fw"></i>
            <span>&ensp;About</span>
        </a>
        
        <a href="/archives">
            <i class="fa-solid fa-box-archive fa-fw"></i>
            <span>&ensp;Archives</span>
        </a>
        
        <a href="/categories">
            <i class="fa-solid fa-bookmark fa-fw"></i>
            <span>&ensp;Categories</span>
        </a>
        
        <a href="/tags">
            <i class="fa-solid fa-tags fa-fw"></i>
            <span>&ensp;Tags</span>
        </a>
        
    </nav>
    <nav id="mobile-menu">
        <div class="title" @click="showMenuItems = !showMenuItems">
            <i class="fa-solid fa-bars fa-fw"></i>
            <span>&emsp;BMILK</span>
        </div>
        <transition name="slide">
            <div class="items" v-show="showMenuItems">
                
                <a href="/">
                    <div class="item">
                        <div style="min-width: 20px; max-width: 50px; width: 10%">
                            <i class="fa-solid fa-house fa-fw"></i>
                        </div>
                        <div style="min-width: 100px; max-width: 150%; width: 20%">Home</div>
                    </div>
                </a>
                
                <a href="/about">
                    <div class="item">
                        <div style="min-width: 20px; max-width: 50px; width: 10%">
                            <i class="fa-solid fa-id-card fa-fw"></i>
                        </div>
                        <div style="min-width: 100px; max-width: 150%; width: 20%">About</div>
                    </div>
                </a>
                
                <a href="/archives">
                    <div class="item">
                        <div style="min-width: 20px; max-width: 50px; width: 10%">
                            <i class="fa-solid fa-box-archive fa-fw"></i>
                        </div>
                        <div style="min-width: 100px; max-width: 150%; width: 20%">Archives</div>
                    </div>
                </a>
                
                <a href="/categories">
                    <div class="item">
                        <div style="min-width: 20px; max-width: 50px; width: 10%">
                            <i class="fa-solid fa-bookmark fa-fw"></i>
                        </div>
                        <div style="min-width: 100px; max-width: 150%; width: 20%">Categories</div>
                    </div>
                </a>
                
                <a href="/tags">
                    <div class="item">
                        <div style="min-width: 20px; max-width: 50px; width: 10%">
                            <i class="fa-solid fa-tags fa-fw"></i>
                        </div>
                        <div style="min-width: 100px; max-width: 150%; width: 20%">Tags</div>
                    </div>
                </a>
                
            </div>
        </transition>
    </nav>
</div>
<transition name="fade">
    <div id="menu-curtain" @click="showMenuItems = !showMenuItems" v-show="showMenuItems"></div>
</transition>

        <div id="main" :class="loading ? 'into-enter-from': 'into-enter-active'">
            <div class="article">
    <div>
        <h1>短链系统设计</h1>
    </div>
    <div class="info">
        
            <span class="date">
                <span class="icon">
                    <i class="fa-solid fa-calendar-days"></i>
                </span>
                2023/12/31
            </span>
        

        
        <span class="category">
            <a href="/categories/%E6%9E%B6%E6%9E%84/">
                <span class="icon">
                    <i class="fa-solid fa-bookmark fa-fw"></i>
                </span>
                架构
            </a>
        </span>
        
        
        <span class="tags">
            <span class="icon">
                <i class="fa-solid fa-tags fa-fw"></i>
            </span>
            
            
            <span class="tag">
                
                <a href="/tags/%E6%9E%B6%E6%9E%84%E8%AE%BE%E8%AE%A1/" style="color: #ff7d73">
                    架构设计
                </a>
            </span>
            
            <span class="tag">
                
                <a href="/tags/%E5%B7%A5%E4%BD%9C/" style="color: #00a596">
                    工作
                </a>
            </span>
            
        </span>
        
    </div>
    
    <div class="content" v-pre>
        <hr>
<h2 id="目录"><a href="#目录" class="headerlink" title="目录"></a>目录</h2><ul>
<li><a href="#%E5%89%8D%E8%A8%80-%E9%A1%B9%E7%9B%AE%E8%83%8C%E6%99%AF">前言 &amp; 项目背景</a></li>
<li><a href="#%E4%BB%80%E4%B9%88%E6%98%AF%E7%9F%AD%E9%93%BE%E6%9C%8D%E5%8A%A1">什么是短链服务</a></li>
<li><a href="#%E5%93%8D%E5%BA%94%E7%A0%81%E7%9A%84%E9%80%89%E6%8B%A9">响应码的选择</a></li>
<li><a href="#%E9%95%BF%E5%BA%A6%E7%9A%84%E9%80%89%E6%8B%A9">长度的选择</a></li>
<li><a href="#%E7%94%9F%E6%88%90%E7%AE%97%E6%B3%95">生成算法</a><ul>
<li><a href="#Hash%E5%87%BD%E6%95%B0%E4%B8%8EUUID">Hash函数与UUID</a></li>
<li><a href="#%E5%88%86%E5%B8%83%E5%BC%8F%E5%94%AF%E4%B8%80ID%E4%B8%8E%E6%97%B6%E9%97%B4%E6%88%B3">分布式唯一ID与时间戳</a></li>
<li><a href="#%E9%A2%84%E7%94%9F%E6%88%90%E7%9F%AD%E9%93%BE">预生成短链</a></li>
</ul>
</li>
<li><a href="#%E4%B8%80%E4%BA%9B%E9%97%AE%E9%A2%98">一些问题</a><ul>
<li><a href="#Base64%E7%BC%96%E7%A0%81%E4%B8%AD%E7%9A%84%22+%22%E5%92%8C%22/%22">Base64编码中的”+”和”&#x2F;“</a></li>
<li><a href="#%E5%A6%82%E4%BD%95%E5%A4%9A%E6%AC%A1%E5%B0%86%E5%90%8C%E4%B8%80%E4%B8%AA%E9%95%BF%E9%93%BE%E6%98%A0%E5%B0%84%E4%B8%BA%E5%90%8C%E4%B8%80%E4%B8%AA%E7%9F%AD%E9%93%BE">如何多次将同一个长链映射为同一个短链</a></li>
<li><a href="#%E4%B8%BA%E4%BB%80%E4%B9%88%E9%80%89%E6%8B%A9Base64%E8%80%8C%E4%B8%8D%E6%98%AFBase62">为什么选择<code>Base64</code>而不是<code>Base62</code></a></li>
</ul>
</li>
<li><a href="#%E5%8F%82%E8%80%83%E8%B5%84%E6%96%99">参考资料</a></li>
</ul>
<hr>
<h2 id="前言-项目背景"><a href="#前言-项目背景" class="headerlink" title="前言 &amp; 项目背景"></a>前言 &amp; 项目背景</h2><p>没有最好的架构设计，只有适合自己的设计，过度设计，劳民伤财。</p>
<p>最近在公司接手了消息平台，每天有百万的消息从这里发出，短信大约占了50W，由于某些原因，公司已经期望通过向关注用户发送微信来降低短信费用，<br>但我了一下发送记录，所有的营销活动、业务通知的短信都使用的长链，这样就会导致一条短信的长度超过70个字符，通讯公司就会按照多条短信进行计费，<br>因此我提议做出了一个短链服务，索性效果还不错。</p>
<h2 id="什么是短链服务"><a href="#什么是短链服务" class="headerlink" title="什么是短链服务"></a>什么是短链服务</h2><p>短链生成算法的核心目标是将一个长URL转换为一个短且唯一的标识符（短链），并且当访问这个较短的链接时候又能正常访问到长链接对应的内容，即为短链服务。所以这里面<br>会包含两部分内容：</p>
<ol>
<li>将长连接转换成短链接提供给用户</li>
<li>用户访问短链接时将短链重定向到长链接的内容<br>短链的访问过程如下图<br><img src="/2023/12/design/%E7%9F%AD%E9%93%BE%E7%B3%BB%E7%BB%9F%E8%AE%BE%E8%AE%A1/%E7%9F%AD%E9%93%BE%E7%B3%BB%E7%BB%9F%E8%AE%BE%E8%AE%A1/%E8%AE%BF%E9%97%AE%E8%BF%87%E7%A8%8B.jpg" alt="短链访问过程"></li>
</ol>
<h4 id="系统功能点"><a href="#系统功能点" class="headerlink" title="系统功能点"></a>系统功能点</h4><p>那么短链服务需要哪些功能呢，我总结如下：</p>
<ol>
<li>将长链转换为短链并保存</li>
<li>用户访问短链可以重定向到长链</li>
<li>对于相同的长链，生成的短链应当相同(非必须要求)</li>
<li>性能要高，能够应对十万乃至百万的并发需求。</li>
<li>链接尽可能的短，使用<code>Base64、Base62</code>编码可能2位就够我们需求了，但是这里还是用了6位，不然下文吹不下去</li>
<li>短链应该不可猜测，即不能猜测某个短链是否存在，不能猜测短链对应的长链内容</li>
</ol>
<h2 id="响应码的选择"><a href="#响应码的选择" class="headerlink" title="响应码的选择"></a>响应码的选择</h2><p>短链的跳转到长链是通过重定向来完成的，<code>301、302</code>两个状态码均表示重定向，那么应该选择哪个呢？</p>
<ul>
<li><code>301</code>代表永久重定向，即在没有清除相应的缓存的情况下，浏览器会缓存目标地址，后续访问相同地址的时候直接访问，而不需要再去短链服务上获取长链</li>
<li><code>302</code>代表临时重定向，每次浏览器都会先向短链服务获取长链， 再进行跳转。</li>
</ul>
<p>因此：如果是公司内部使用，<code>301</code>就足够了，如果有统计相关需求，可以在目标页面做相应的埋点处理， 如果是商业化产品，可能涉及到计费、统计的问题，就需要使用<br><code>302</code>。</p>
<h2 id="长度的选择"><a href="#长度的选择" class="headerlink" title="长度的选择"></a>长度的选择</h2><p>在生成短链之前需要确认短链的长度是多少，像微博用的是7位的短链，京东用的是6位短链，并且使用的编码方式也不太一样，微博为<code>Base62</code>， 京东为<code>Base64</code>。<br>具体如何选择， 还是要看自己的预期目标，根据预期需要的短链数，再加上合理的冗余数量来选择，下面列举了不同编码和长度可提供的短链个数</p>
<table>
<thead>
<tr>
<th align="center">编码方式</th>
<th align="center">6个字符</th>
<th align="center">7个字符</th>
</tr>
</thead>
<tbody><tr>
<td align="center"><code>Base62</code></td>
<td align="center">约568亿</td>
<td align="center">约35216亿</td>
</tr>
<tr>
<td align="center"><code>Base64</code></td>
<td align="center">约687亿</td>
<td align="center">约43980亿</td>
</tr>
</tbody></table>
<p>我们的项目最后使用的是6位编码。</p>
<h2 id="生成算法"><a href="#生成算法" class="headerlink" title="生成算法"></a>生成算法</h2><p>短链系统有很重要的一环就是生成算法，生成算法决定了生成的效率（生成性能）、实现复杂度以及是否可以被逆向分析。</p>
<h4 id="Hash函数与UUID"><a href="#Hash函数与UUID" class="headerlink" title="Hash函数与UUID"></a>Hash函数与UUID</h4><p><code>Hash</code>时最简单最快的实现方案，通常是将长<code>URL</code>利用某种哈希算法进行哈希计算， 然后将结果进行<code>Base64</code>编码，再截取前6位就是短链。</p>
<p>理想很丰满，现实很骨感，这样得到的短链很有可能会发生<code>哈希冲突</code>, 将长链计算出的哈希值是一样的（也有可能不一样，但是经过<code>Base64</code>编码后前6位一样）。<br>所以在生成短链的时候需要校验该短链是都已经映射到其他长链。如果有则需要重新计算（更换哈希算法或者截取<code>Base64</code>编码后的不同位置）。但是这样会随着时间数据量的<br>增大校验的数据越来越多，导致创建效率变慢。算法推荐使用<a target="_blank" rel="noopener" href="https://zh.wikipedia.org/wiki/Murmur%E5%93%88%E5%B8%8C">MurmurHash</a>算法，可以一定程度上降低冲突概率。</p>
<p>与此相对应的还有直接使用<code>UUID</code>前6位作为短链的，同样的会产生冲突的问题。<br>总体流程图如下：<br><img src="/2023/12/design/%E7%9F%AD%E9%93%BE%E7%B3%BB%E7%BB%9F%E8%AE%BE%E8%AE%A1/%E7%9F%AD%E9%93%BE%E7%B3%BB%E7%BB%9F%E8%AE%BE%E8%AE%A1/Hash%E5%92%8CUUID.png" alt="Hash函数与UUID流程"></p>
<h4 id="分布式唯一ID与时间戳"><a href="#分布式唯一ID与时间戳" class="headerlink" title="分布式唯一ID与时间戳"></a>分布式唯一ID与时间戳</h4><p>分布式唯一ID的方式分为两步i：</p>
<ol>
<li>获取一个唯一ID</li>
<li>将这个ID进行<code>Base64</code>编码，即为短链。</li>
</ol>
<p>分布式唯一ID也是有很多的算法，例如数据库自增ID、redis自增ID、发号器等等，这些方式都有很强的规律性，当获用户取到一个短链之后，<br>很容易根据一个短链预测出其他短链并访问，因此如果有<strong>不可猜测</strong>需求的场景应当避免使用。</p>
<p>还有一种方式是雪花算法得到唯一ID， 如果在短时间内产生一批短链，雪花ID也是可以被预测的，但如果生成的时间不集中， <strong>可猜测</strong>这个问题似乎就可以被<strong>掩盖</strong><br>同样道理的还有使用时间戳。只要生成时间不集中，可预测的问题就会被掩盖。我们使用的就是时间戳，我们系统要十天半个月才会生成一次短链给用户推广营销短信。<br>我们使用秒级时间戳，并且对时间戳做一定的处理避免长度超过6位（将当前时间戳减去一个基准时间戳），这样来看我们的短链会随着时间流逝用完，不过那也是几百年后的事情。</p>
<p>如果真有秒级时间内生成多个短链的需求怎么办呢，只需要在生成后加一个校验即可，如果冲突再重新生成<br>总体流程图如下：<br><img src="/2023/12/design/%E7%9F%AD%E9%93%BE%E7%B3%BB%E7%BB%9F%E8%AE%BE%E8%AE%A1/%E7%9F%AD%E9%93%BE%E7%B3%BB%E7%BB%9F%E8%AE%BE%E8%AE%A1/%E5%88%86%E5%B8%83%E5%BC%8FID.png" alt="分布式唯一ID与时间戳"></p>
<h4 id="预生成短链"><a href="#预生成短链" class="headerlink" title="预生成短链"></a>预生成短链</h4><p>面对大规模的短链请求时，一种可行的方案时<strong>预生成</strong>， 即提前计算好要生成多少短链，并在这个基础上提供一定的冗余，存储在某个地方，在需要的时候直接获取即可。<br>预生成的方式为使用随机数，先在0~63的范围内生成随机数，再根据编码表转换成短链，然后判断短链是否存在， 如果存在这重新生成。这似乎和<code>Hash</code>一样会产生冲突并引发性能问题。<br>但预生成的核心就在<strong>预</strong>字上面， 我们可以提前生成一批短链，这个过程和对外提供短链服务的过程是隔离的，我们甚至可以在上线前就预生成好短链，并且按照一定时间加载到短链服务中。</p>
<p>这里使用布隆过滤器判断短链是否存在，<br>使用文件服务器存储预加载的短链，<br>预生成过程如下图</p>
<p><img src="/2023/12/design/%E7%9F%AD%E9%93%BE%E7%B3%BB%E7%BB%9F%E8%AE%BE%E8%AE%A1/%E7%9F%AD%E9%93%BE%E7%B3%BB%E7%BB%9F%E8%AE%BE%E8%AE%A1/%E9%A2%84%E7%94%9F%E6%88%90%E8%BF%87%E7%A8%8B.png" alt="预生成过程"></p>
<p>完整时序图如下：<br><img src="/2023/12/design/%E7%9F%AD%E9%93%BE%E7%B3%BB%E7%BB%9F%E8%AE%BE%E8%AE%A1/%E7%9F%AD%E9%93%BE%E7%B3%BB%E7%BB%9F%E8%AE%BE%E8%AE%A1/%E9%A2%84%E7%94%9F%E6%88%90%E5%AE%8C%E6%95%B4%E6%97%B6%E5%BA%8F%E5%9B%BE.jpg" alt="预生成时序图"></p>
<h2 id="一些问题"><a href="#一些问题" class="headerlink" title="一些问题"></a>一些问题</h2><h4 id="Base64编码中的”-”和”-“"><a href="#Base64编码中的”-”和”-“" class="headerlink" title="Base64编码中的”+”和”&#x2F;“"></a>Base64编码中的”+”和”&#x2F;“</h4><p><code>Base64</code>编码中有两个特殊字符<code>+</code>和<code>/</code>，在<code>URL</code>的编码中会被编码为<code>%2B</code>和<code>%2F</code>， 并且<code>%</code>在写入数据库中时可能会和<code>SQL</code>编码规则冲突，因此直接使用标准的<br><code>Base64</code>编码并不合适，我们应该避开<code>URL</code>保留字符编码， 因此我们将<code>+</code>替换为<code>-</code>， 将<code>/</code>和<code>_</code>。</p>
<h4 id="如何多次将同一个长链映射为同一个短链"><a href="#如何多次将同一个长链映射为同一个短链" class="headerlink" title="如何多次将同一个长链映射为同一个短链"></a>如何多次将同一个长链映射为同一个短链</h4><p>这个其实是一个选择问题，是不是同一个短链并不是很重要， 因为整个业务目标是打开长链对应的地址，我们可以是多个短链对应一个长链。<br>但是我们还是会去想在一定程度内保证只有一个短链。因此我们选择将长链到短链的映射存储在<code>redis</code>中一份，当<code>redis</code>中没有时就认为长链没有映射到短链，可以重新生成，<br><code>redis</code>中的数据保存7天，一般情况下， 我们一个活动大概时14天，存储7天长链到短链的映射足够了。当然也可以去数据库中判断是否存在这个映射关系，在数据量大、<br>并发高的时候会性能问题，需要综合考虑。</p>
<h4 id="为什么选择Base64而不是Base62"><a href="#为什么选择Base64而不是Base62" class="headerlink" title="为什么选择Base64而不是Base62"></a>为什么选择Base64而不是Base62</h4><p><code>Base64</code>相较于<code>Base62</code>有一个好处就是64刚好是2的6次方，对应2进制6位，计算编码的时候星能略好于<code>Base62</code>。</p>
<p>但是如果使用的是预生成的方式，就没有什么区别。</p>
<h2 id="参考资料"><a href="#参考资料" class="headerlink" title="参考资料"></a>参考资料</h2><ul>
<li><a href="#https://time.geekbang.org/column/article/488496">短 URL 生成器设计：百亿短 URL 怎样做到无冲突？</a></li>
<li><a href="#https://cloud.tencent.com/developer/article/2330726">如何设计一个高性能短链系统？</a></li>
</ul>
<hr>
<p><font color="#FF3030">转载请标明出处</font></p>

    </div>
    
    
    
    
    <div id="comment">
        <div id="giscus-container" class="giscus"></div>
    </div>
    
    
    
    
</div>

            <footer id="footer">
    <div id="footer-wrap">
        <div>
            &copy;
            2022 - 2024 bmilk
            <span id="footer-icon">
                <i class="fa-solid fa-font-awesome fa-fw"></i>
            </span>
            &commat;Du Jian
        </div>
        <div>
            Based on the <a target="_blank" rel="noopener" href="https://hexo.io">Hexo Engine</a> &amp;
            <a target="_blank" rel="noopener" href="https://github.com/theme-particlex/hexo-theme-particlex">ParticleX Theme</a>
        </div>
        
    </div>
</footer>

        </div>
        
        <transition name="fade">
            <div id="preview" ref="preview" v-show="previewShow">
                <img id="preview-content" ref="previewContent" />
            </div>
        </transition>
        
    </div>
    <script src="/js/main.js"></script>
    
    
<script
    src="https://giscus.app/client.js"
    data-repo="dujian0068/blog"
    data-repo-id="R_kgDOGryLBA"
    data-category="Announcements"
    data-category-id="DIC_kwDOGryLBM4ChDAf"
    data-mapping="pathname"
    data-strict="0"
    data-reactions-enabled="1"
    data-emit-metadata="0"
    data-input-position="bottom"
    data-theme="preferred_color_scheme"
    data-lang="zh-CN"
    crossorigin
    async
></script>





    
</body>
</html>
